unit FileVersion;

interface

type

  TVerInfo=packed record
    Dummy: array[0..47] of byte; // ненужные нам 48 байт
    Minor,Major,Build,Release: word; // а тут версия
  end;

  TFileVersion = class(TObject)
  private
    procedure Init;
  public
    v:TVerInfo;
    constructor Create(sFile: string);
  end;

implementation

uses
  System.Classes;

constructor TFileVersion.Create(sFile: string);
begin
  Init;
end;

procedure TFileVersion.Init;
                        //http://www.delphilab.ru/content/view/78/63/
                        // by Snowy

var
  s:TResourceStream;
begin

  try
    s:=TResourceStream.Create(HInstance,'#1', 'RT_VERSION'); // достаём ресурс
    if s.Size>0 then begin
      s.Read(v,SizeOf(v)); // читаем нужные нам байты
      //result:=IntToStr(v.Major)+'.'+IntToStr(v.Minor)+'.'+ // вот и версия...
        //      IntToStr(v.Release)+'.'+IntToStr(v.Build);
    end;
  s.Free;
  except; end;
end;

{procedure TFileVersion.Init;
        const
            Prefix = '\StringFileInfo\040904E4\';
        var
            FData              : Pointer;
            FSize              : LongInt;
            FIHandle           : THandle;
            FFileName          : string;
            FFileVersion       : string;

        function GetVerValue(Value: string):string;
        var
          ItemName: string;
          Len   : Cardinal;
          vVers : Pointer;
        begin
          ItemName := Prefix + Value;
          Result := '';

          if VerQueryValue(FData, PChar(ItemName), vVers, Len) then
             if Len > 0 then begin
                if Len > 255 then
                   Len := 255;
                Result := Copy(PChar(vVers), 1 , Len);
             end;
        end;

        function GetFileVersion: string;
        begin
          if FSize > 0 then begin
             GetMem(FData, FSize);
             try
               if GetFileVersionInfo(PChar(FFileName), FIHandle, FSize, FData) then begin
                 FFileVersion:= GetVerValue('FileVersion');
               end;
             finally
               FreeMem(FData, FSize);
             end;
          end;
          Result := FFileVersion;
        end;

    begin
        Result := '';
        if FileExists( fName ) then begin
           FFileName := fName;
           FSize := GetFileVersionInfoSize(PChar(FFileName), FIHandle);
           Result := GetFileVersion;
        end;
    end; { function }  //}



end.
